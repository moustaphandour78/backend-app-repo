<!DOCTYPE html>
<html lang="fr_FR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des demandes - Commune de Daroul Mouhty</title>

    <link rel="icon" href="mairie_img/logo_img.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet"/>
    
    <link rel="stylesheet" href="styles-admin.css">
  </head>
  <body class="admin-body">
    <!-- Page d'administration -->
    <div id="admin-page">
      <header class="admin-header">
        <nav id="navmenu" class="navbar">
          <div class="logo_wrapper">
            <a href="#" class="nav-logo">
              <img src="mairie_img/logo_img.jpg" alt="logo mairie" class="logo_mairie">
              <h3 class="logo-text">Commune de Daroul<br>Mouhty</br></h3>
            </a>
          </div>
          
          <button id="menu-close-button" class="fas fa-times"></button>
          <ul class="nav-menu">
            <li class="nav-item">
              <button id="logout-btn" class="nav-link">
                <i class="fas fa-sign-out-alt"></i>Accueil
              </button>
            </li>
            
          </ul>
          <button id="menu-open-button" class="fas fa-bars"></button>
          
        </nav>
      </header>

      <main>
        <div class="admin-container">
          <div class="admin-header">
            <h1 class="admin-title">Gestion des demandes d'état civil</h1>
            <div class="admin-actions">
              <button id="export-btn" class="btn btn-outline">
                <i class="fas fa-file-export"></i> Exporter
              </button>
            </div>
          </div>
          
          <div class="dashboard-cards">
            <div class="dashboard-card">
              <div class="card-icon" style="color: var(--secondary-color);">
                <i class="fas fa-inbox"></i>
              </div>
              <h3 class="card-title">Total des demandes</h3>
              <div class="card-value" id="total-requests">0</div>
            </div>
            
            <div class="dashboard-card">
              <div class="card-icon" style="color: var(--warning-color);">
                <i class="fas fa-spinner"></i>
              </div>
              <h3 class="card-title">En traitement</h3>
              <div class="card-value" id="processing-requests">0</div>
            </div>
            
            <div class="dashboard-card">
              <div class="card-icon" style="color: var(--success-color);">
                <i class="fas fa-check-circle"></i>
              </div>
              <h3 class="card-title">Traitées</h3>
              <div class="card-value" id="completed-requests">0</div>
            </div>
            
            <div class="dashboard-card">
              <div class="card-icon" style="color: var(--danger-color);">
                <i class="fas fa-times-circle"></i>
              </div>
              <h3 class="card-title">Rejetées</h3>
              <div class="card-value" id="rejected-requests">0</div>
            </div>
          </div>
          
          <div class="requests-table">
            <div class="table-header">
              <h3 class="table-title">Liste des demandes récentes</h3>
              <div class="table-actions">
                <div class="search-box">
                  <i class="fas fa-search"></i>
                  <input type="text" id="search-input" placeholder="Rechercher...">
                </div>
                <select id="status-filter" class="btn btn-outline">
                  <option value="all">Tous les statuts</option>
                  <option value="new">Nouveau</option>
                  <option value="processing">En traitement</option>
                  <option value="completed">Traité</option>
                  <option value="rejected">Rejeté</option>
                </select>
              </div>
            </div>
            
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Prénom et Nom</th>
                  <th>Type de document</th>
                  <th>Date de demande</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requests-table-body">
                <!-- Les demandes seront ajoutées dynamiquement ici -->
              </tbody>
            </table>
          </div>
        </div>
      </main>

      <!-- Modal pour voir les détails d'une demande -->
      <div class="modal-overlay" id="request-modal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">Détails de la demande</h3>
            <button class="modal-close" id="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <div class="request-details">
              <div class="detail-group">
                <label class="detail-label">ID de suivi</label>
                <div class="detail-value" id="detail-tracking-number"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Nom complet</label>
                <div class="detail-value" id="detail-name"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Date de naissance</label>
                <div class="detail-value" id="detail-birth-date"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Type de document</label>
                <div class="detail-value" id="detail-document-type"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Téléphone</label>
                <div class="detail-value" id="detail-phone"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Email</label>
                <div class="detail-value" id="detail-email"></div>
              </div>
              
              <div class="detail-group full-width">
                <label class="detail-label">Message</label>
                <div class="detail-value" id="detail-message"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Date de soumission</label>
                <div class="detail-value" id="detail-submission-date"></div>
              </div>
              
              <div class="detail-group">
                <label class="detail-label">Statut</label>
                <div class="detail-value" id="detail-status"></div>
              </div>
              
              <div class="detail-group full-width">
                <label class="detail-label">Commentaire</label>
                <div class="detail-value" id="detail-comment"></div>
              </div>
            </div>
            
            <div class="status-form">
              <h4>Mettre à jour le statut</h4>
              <div class="form-group">
                <label for="status-select">Nouveau statut</label>
                <select id="status-select" class="form-control">
                  <option value="new">Nouveau</option>
                  <option value="processing">En traitement</option>
                  <option value="completed">Traité</option>
                  <option value="rejected">Rejeté</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="comment-textarea">Commentaire (optionnel)</label>
                <textarea id="comment-textarea" placeholder="Ajouter un commentaire..."></textarea>
              </div>
              
              <button id="update-status-btn" class="btn btn-primary" data-request-id="">Mettre à jour</button>
            </div>
          </div>
          
          <div class="modal-footer">
            <button class="btn btn-outline" id="modal-close-footer">Annuler</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer-section">
      <div class="section-content">
        <p class="copyright-text"> © 2025 Mairie de Daroul mouhty</p>
        <div class="social-link-list">
          <a href="https://web.facebook.com/communedaroumousty/photos?locale=fr_FR" class="social-link">
            <i class="fa-brands fa-facebook"></i>
          </a>
          <a href="https://www.instagram.com/communedaroumousty/" class="social-link">
            <i class="fa-brands fa-instagram"></i>
          </a>
          <a href="https://twitter.com/communedaroumousty" class="social-link">
            <i class="fa-brands fa-twitter"></i>
          </a>
        </div>
        <p class="policy-text">
          <a href="#" class="policy-link">Réalisation | Bluetech</a>
          <span class="separator">-</span>
          <a href="#" class="policy-link">Email : bleudiallo@gmail.com</a>
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
      // Configuration simplifiée de l'API
      const API_CONFIG = {
        BASE_URL: 'http://localhost:3003/api',
        HEADERS: {
          'Authorization': 'Bearer admin123'
        },
        ENDPOINTS: {
          REQUESTS: {
            BASE: '/demandes',
            STATS: '/demandes/stats',
            EXPORT: '/demandes/export',
            UPDATE_STATUS: (id) => `/demandes/${id}/status`
          }
        }
      };

      // Gestionnaire des requêtes API
      const API = {
        fetchRequests: async function(params = {}) {
          const response = await axios.get(
            API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.REQUESTS.BASE,
            {
              params,
              headers: API_CONFIG.HEADERS
            }
          );
          return response.data;
        },

        fetchStats: async function() {
          const response = await axios.get(
            API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.REQUESTS.STATS,
            { headers: API_CONFIG.HEADERS }
          );
          return response.data;
        },

        updateRequestStatus: async function(requestId, status, comment = '') {
          const response = await axios.put(
            API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.REQUESTS.UPDATE_STATUS(requestId),
            { status, comment },
            { headers: API_CONFIG.HEADERS }
          );
          return response.data;
        },

        exportRequests: async function() {
          const response = await axios.get(
            API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.REQUESTS.EXPORT,
            {
              responseType: 'blob',
              headers: API_CONFIG.HEADERS
            }
          );
          return response.data;
        }
      };

      // Initialisation de l'application
      document.addEventListener('DOMContentLoaded', function() {
        loadAdminData();
      });
      
      // Gestion de l'export
      document.getElementById('export-btn').addEventListener('click', async () => {
        try {
          const data = await API.exportRequests();
          const url = window.URL.createObjectURL(new Blob([data]));
          const link = document.createElement('a');
          link.href = url;
          link.setAttribute('download', 'demandes.json');
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);
        } catch (error) {
          console.error('Erreur d\'export:', error);
          alert('Erreur lors de l\'export des données');
        }
      });

      // Chargement des données admin
      async function loadAdminData() {
        try {
          const [stats, requests] = await Promise.all([
            API.fetchStats(),
            API.fetchRequests()
          ]);
          
          updateDashboard(stats);
          renderRequests(requests);
        } catch (error) {
          console.error('Erreur de chargement des données:', error);
          alert('Erreur lors du chargement des données');
        }
      }

      // Mettre à jour le tableau de bord
      function updateDashboard(stats) {
        document.getElementById('total-requests').textContent = stats.total || 0;
        document.getElementById('processing-requests').textContent = stats.processing || 0;
        document.getElementById('completed-requests').textContent = stats.completed || 0;
        document.getElementById('rejected-requests').textContent = stats.rejected || 0;
      }

      // Afficher les demandes
      function renderRequests(requests) {
        const tbody = document.getElementById('requests-table-body');
        tbody.innerHTML = '';
        
        requests.forEach(request => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${request.id}</td>
            <td>${request.fullName}</td>
            <td>${request.documentType}</td>
            <td>${new Date(request.date).toLocaleDateString()}</td>
            <td><span class="status status-${request.status}">${getStatusText(request.status)}</span></td>
            <td>
              <button class="action-btn view-btn" data-id="${request.id}">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Ajouter les écouteurs d'événements pour les boutons
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', () => viewRequestDetails(btn.dataset.id));
        });
      }

      // Afficher les détails d'une demande
      async function viewRequestDetails(requestId) {
        try {
          const response = await axios.get(
            `${API_CONFIG.BASE_URL}/demandes/${requestId}`,
            { headers: API_CONFIG.HEADERS }
          );
          const request = response.data;
          
          // Remplir les détails du modal
          document.getElementById('detail-tracking-number').textContent = request.trackingNumber || 'N/A';
          document.getElementById('detail-name').textContent = request.fullName || 'N/A';
          document.getElementById('detail-birth-date').textContent = request.birthDate || 'N/A';
          document.getElementById('detail-document-type').textContent = request.documentType || 'N/A';
          document.getElementById('detail-phone').textContent = request.phone || 'N/A';
          document.getElementById('detail-email').textContent = request.email || 'N/A';
          document.getElementById('detail-message').textContent = request.message || 'Aucun message';
          document.getElementById('detail-submission-date').textContent = request.date ? new Date(request.date).toLocaleString() : 'N/A';
          document.getElementById('detail-status').innerHTML = `<span class="status status-${request.status}">${getStatusText(request.status)}</span>`;
          document.getElementById('detail-comment').textContent = request.comment || 'Aucun commentaire';
          
          // Pré-remplir le formulaire de mise à jour du statut
          document.getElementById('status-select').value = request.status || 'new';
          document.getElementById('comment-textarea').value = request.comment || '';
          document.getElementById('update-status-btn').dataset.requestId = requestId;
          
          // Afficher le modal
          document.getElementById('request-modal').classList.add('active');
        } catch (error) {
          console.error('Erreur de récupération des détails:', error);
          alert('Erreur lors de la récupération des détails');
        }
      }

      // Helper pour le texte du statut
      function getStatusText(status) {
        const statusMap = {
          'new': 'Nouveau',
          'processing': 'En traitement',
          'completed': 'Traité',
          'rejected': 'Rejeté'
        };
        return statusMap[status] || status;
      }

      // Gestion du modal
      document.getElementById('modal-close').addEventListener('click', () => {
        document.getElementById('request-modal').classList.remove('active');
      });
      
      document.getElementById('modal-close-footer').addEventListener('click', () => {
        document.getElementById('request-modal').classList.remove('active');
      });
      
      // Mise à jour du statut d'une demande
      document.getElementById('update-status-btn').addEventListener('click', async function() {
        const requestId = this.dataset.requestId;
        const status = document.getElementById('status-select').value;
        const comment = document.getElementById('comment-textarea').value;
        
        try {
          const updatedRequest = await API.updateRequestStatus(requestId, status, comment);
          
          // Fermer le modal
          document.getElementById('request-modal').classList.remove('active');
          
          // Recharger les données
          loadAdminData();
          
          alert('Statut mis à jour avec succès');
        } catch (error) {
          console.error('Erreur de mise à jour du statut:', error);
          alert('Erreur lors de la mise à jour du statut');
        }
      });

      // Gestion de la recherche/filtre
      document.getElementById('search-input').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filterRequests(searchTerm);
      });

      document.getElementById('status-filter').addEventListener('change', (e) => {
        const status = e.target.value;
        filterRequests(null, status);
      });

      function filterRequests(searchTerm = null, status = 'all') {
        const rows = document.querySelectorAll('#requests-table-body tr');
        
        rows.forEach(row => {
          const name = row.cells[1].textContent.toLowerCase();
          const requestStatus = row.cells[4].textContent.toLowerCase();
          
          const matchesSearch = !searchTerm || name.includes(searchTerm);
          const matchesStatus = status === 'all' || requestStatus === status.toLowerCase();
          
          row.style.display = matchesSearch && matchesStatus ? '' : 'none';
        });


        
        // Gestion du menu responsive
        const menuOpenButton = document.getElementById('menu-open-button');
        const menuCloseButton = document.getElementById('menu-close-button');
        const navMenu = document.querySelector('.nav-menu');

        if (menuOpenButton && menuCloseButton && navMenu) {
          menuOpenButton.addEventListener('click', () => {
            navMenu.classList.add('active');
          });

          menuCloseButton.addEventListener('click', () => {
            navMenu.classList.remove('active');
          });
        }
      }

      
    </script>
  </body>
</html>